name: CI Workflow

on:
  push:
    branches: ["main", "master", "develop"]
  pull_request:

jobs:
  build-test:
    runs-on: ubuntu-latest
    environment: Development

    env:
      # Database
      DATABASE_HOST: ${{ vars.DATABASE_HOST }}
      DATABASE_USER: ${{ secrets.DATABASE_USER }}
      DATABASE_PASSWORD: ${{ secrets.DATABASE_PASSWORD }}
      DATABASE_NAME: ${{ vars.DATABASE_NAME }}
      DATABASE_PORT: ${{ vars.DATABASE_PORT }}
      DATABASE_SSL_MODE: ${{ vars.DATABASE_SSL_MODE }}

      # App
      APP_ADDR: ${{ vars.APP_ADDR }}

      # JWT
      JWT_ACCESS_SECRET: ${{ secrets.JWT_ACCESS_SECRET }}
      JWT_VERIFICATION_SECRET: ${{ secrets.JWT_VERIFICATION_SECRET }}

      # SMTP
      SMTP_HOST: ${{ vars.SMTP_HOST }}
      SMTP_PORT: ${{ vars.SMTP_PORT }}
      SMTP_SENDER: ${{ vars.SMTP_SENDER }}
      SMTP_EMAIL: ${{ secrets.SMTP_EMAIL }}
      SMTP_PASSWORD: ${{ secrets.SMTP_PASSWORD }}

      # Redis
      REDIS_HOST: ${{ vars.REDIS_HOST }}
      REDIS_PORT: ${{ vars.REDIS_PORT }}
      REDIS_PASSWORD: ${{ secrets.REDIS_PASSWORD }}

      # Target URL
      TARGET_URL: ${{ vars.FRONTEND_URL }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true

      - name: Download deps
        run: go mod download

      - name: Debug env presence (safe)
        run: |
          echo "DATABASE_HOST set? ${{ vars.DATABASE_HOST != '' }}"
          echo "DATABASE_NAME set? ${{ vars.DATABASE_NAME != '' }}"
          echo "DATABASE_PORT set? ${{ vars.DATABASE_PORT != '' }}"
          echo "DATABASE_USER secret set? ${{ secrets.DATABASE_USER != '' }}"
          echo "DATABASE_PASSWORD secret set? ${{ secrets.DATABASE_PASSWORD != '' }}"
          echo "REDIS_HOST set? ${{ vars.REDIS_HOST != '' }}"
          echo "REDIS_PORT set? ${{ vars.REDIS_PORT != '' }}"
          echo "REDIS_PASSWORD secret set? ${{ secrets.REDIS_PASSWORD != '' }}"

      - name: Migrate
        run: go run ./cmd/migrate

      - name: Test
        run: go test ./e2e

      - name: Vet
        run: go vet ./...

      - name: Build
        run: go build ./cmd/api